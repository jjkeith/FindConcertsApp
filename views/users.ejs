<div class="container-fluid">

  <div class=row>
    <div class="col-sm-5 col-sm-offset-0">
      <h2 class = "page-header">Who's playing where?<br>
      <small>Enter your address below to find shows happening today</small></h2>
    </div>

      <div class="col-sm-5 col-sm-offset-2">
        <h2 class = "page-header">Chat with other concert goers<br>
        <small>Share tips, reviews, make plans, meet up with friends</small></h2>
      </div>
      <div class="chat_div">


<!-- Put socket chat here -->





      </div>
    </div>

  <form id ="search-form" method="GET">
    <div class="form-group row">
      <div class="col-sm-2 col-sm-offset-0">
        <label for="inputAddress" class="form-control-label">Enter Address</label>
      </div>
      <div class="col-sm-3">
        <input type="text" class="form-control" id="address-input" placeholder="Enter Address" value= '<%= user.local.zipcode %>'>
      </div>
    </div>
    <div class="form-group row">
      <div class="col-sm-0 col-sm-offset-0">
        <button type="submit" class="btn btn-primary">Search</button>
      </div>
    </div>

  </form>

  <div class="padding"></div>
    <p>Click on a marker for more information about an event</p>
    <div id="map-container" class="col-sm-8 col-sm-offset-0">

    </div>

<div class="padding"></div>

<div class="saved-shows col-sm-8 col-sm-offset-0">
  <table class="table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Date and Time</th>
        <th>Tickets</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>"Skrillex @ Jack Ãœ @ FVDED in the Park in Surrey, Canada"</td>
        <td>"Saturday, July 2, 2016 at 7:00PM"</td>
        <td><a href="http://www.bandsintown.com/event/11680295/buy_tickets?app_id=YOUR_APP_ID&artist=Skrillex&came_from=67"</a>Click here</td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td><a href=""</a></td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<script type="text/javascript">

$('#search-form').submit(function() {

  var searchAddress = $('#address-input').val()
  var eventDisplay = $('#events-display')

  $.ajax({
    url: '/geocode',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({data: searchAddress})
  })
  .done(function(data){
    console.log('client side dataaasssss', data);
    $.get('/search?query=' + data.latitude + ', ' + data.longitude )
    .done(function(queryData){
      map.panTo({lat: data.latitude, lng: data.longitude});
      var latLng = {lat: data.latitude, lng: data.longitude}

      queryData.events.forEach(function(el){
        var latLng = {lat: el.venue.latitude, lng: el.venue.longitude}
        placeMarker(latLng, map, el)
      });
    })
  })

  $('#address-input').val('');

  console.log('message sending');
  return false;
});

function initMap() {
  map = new google.maps.Map(document.getElementById('map-container'), {
    //General Assembly SM's coordinates
    center: {lat: 34.013, lng: -118.495},
    zoom: 13
  });
}

function placeMarker(latLng, map, eventObj) {
  var marker = new google.maps.Marker({
  position: latLng,
  map: map,
  eventInfo: eventObj
});

marker.addListener('mouseover', function(){
  console.log(this.eventInfo);
  console.log(this.eventInfo.id);
  console.log(eventId);
  console.log(this.eventInfo.datetime);
  console.log(this.eventInfo.ticket_url);
  var eventId = this.eventInfo.id
  var eventTitle = this.eventInfo.title
  var contentString = '<h4>' + this.eventInfo.artists[0].name + '</h4><p>' + this.eventInfo.venue.name + '</p><button><a href=/events/' + eventId + '>Add to my Shows</a></button>'
//right about here is where the URL should be concatenated.

  var infowindow = new google.maps.InfoWindow({
    content: contentString
  });
    infowindow.open(map, marker);
    marker.addListener('mouseout', function(){
      setTimeout(function() {
        infowindow.close(map, marker);
      }, 800)
    })
    marker.addListener('click', function(){
      sessionStorage.setItem( 'eventID',this.eventInfo.id )
      sessionStorage.setItem( 'event', JSON.stringify(this.eventInfo) )
      window.location = '/event'
    })
  })
}

</script>

<script src= "https://maps.googleapis.com/maps/api/js?key=AIzaSyBg7qsdMIt6_u3lp0AfjJoz41S2C8fyCRg&callback=initMap"
 async defer>

 </script>
