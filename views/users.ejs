<div class="padding"></div>

<form id ="search-form" method="GET">
  <div class="form-group row">
    <div class="col-sm-6">
      <h2>Search for Events</h2>
    </div>
  </div>

  <div class="form-group row">
    <label for="inputAddress" class="col-sm-2 form-control-label">Enter Address</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="address-input" placeholder="Enter Address" value= '<%= user.local.zipcode %>'>
    </div>
  </div>

  <div class="form-group row">
    <label for="inputRadius" class="col-sm-2 form-control-label">Search Radius</label>
    <div class="col-sm-4">
      <input type="number" class="form-control" id="radius-input" placeholder="Enter Search Radius" value= '10'>
    </div>
  </div>

  <div class="form-group row">
    <div class="col-sm-4 col-sm-offset-2">
      <button type="submit" class="btn btn-primary">Search</button>
    </div>
  </div>

</form>

<div class="padding"></div>

<!-- TODO for testing - needs to be moved to events.ejs -->
<div class="row">
  <div id="map-container" class="col-sm-6">

  </div>
</div>
<div id="events-display">

</div>

<style>
  #messages { max-width: 350px; height: 300px; overflow-y: scroll}
  #formnamehere { max-width: 500px;}
  .chat-window { font: 13px Helvetica, Arial; float: right; }
  #chat-form { background: #000; padding: 3px; width: 100%; }
  #m { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
  #send-button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
  #messages { list-style-type: none; margin: 0; padding: 0; }
  #messages li { padding: 5px 10px; }
  #messages li:nth-child(odd) { background: #eee; }

</style>
</head>
<body>

<div class="chat-window">
  <ul id="messages"></ul>
    <form id="chat-form" action="">
      <input id="m" autocomplete="off" /><button id="send-button">Send</button>
    </form>

</div>
<script src="/socket.io/socket.io.js"></script>
  <script>
    var socket = io();

    $('form').submit(function(){
      socket.emit('send-chat', $('#m').val());
      $('#m').val('');
      return false;
    });

    socket.on('r chat', function(msg){
      console.log(msg);
      var timestamp = moment(msg.timestamp).format('h:mm:a')
      $('#messages').append('<li><small>' + timestamp + '</small> ' + msg + '</li>')
    })

  </script>
</body>

<script type="text/javascript">
// var socket = io();
$('#search-form').submit(function() {


  // socket.emit('send-search', $('#address-input').val());
  var searchAddress = $('#address-input').val()
  var searchRadius = $('#radius-input').val()
  var eventDisplay = $('#events-display')

  $.ajax({
    url: '/geocode',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({data: searchAddress}, {data: searchRadius})
  })
  .done(function(data){
    console.log('client side dataaasssss', data);
    $.get('/search?query=' + data.latitude + ', ' + data.longitude )
    .done(function(queryData){
      eventDisplay.text(JSON.stringify(queryData.events))
      console.log('qqquerryryryryryr datataa', queryData)
      console.log(data.latitude, data.longitude);
      map.panTo({lat: data.latitude, lng: data.longitude});
      var latLng = {lat: data.latitude, lng: data.longitude}

      queryData.events.forEach(function(el){
        var latLng = {lat: el.venue.latitude, lng: el.venue.longitude}
        placeMarker(latLng, map, el)
      });

})
})

  $('#address-input').val('');
  $('#radius-input').val('');


  console.log('message sending');
  return false;
});

function initMap() {
  map = new google.maps.Map(document.getElementById('map-container'), {
    center: {lat: -34.397, lng: 150.644},
    zoom: 8
  });
}

function placeMarker(latLng, map, eventObj) {
    // console.log('placemarker:', latLng, map);
    var marker = new google.maps.Marker({
    position: latLng,
    map: map,
    eventInfo: eventObj
  });

  marker.addListener('mouseover', function(){
    console.log(this.eventInfo)
    var eventId = this.eventInfo.id
    var eventPageLink = '<br><button id="'+ eventId + '" class="more-info">More Info</button>'
    var contentString = this.eventInfo.artists[0].name + ' AT ' + this.eventInfo.venue.name + eventPageLink
    var infowindow = new google.maps.InfoWindow({
      content: contentString
    });

    infowindow.open(map, marker);
    marker.addListener('mouseout', function(){
      // console.log(this.eventInfo)
      // var eventId = this.eventInfo.id
      // var eventPageLink = '<br><button id="'+ eventId + '" class="more-info">More Info</button>'
      // var contentString = this.eventInfo.artists[0].name + ' AT ' + this.eventInfo.venue.name + eventPageLink
      // var infowindow = new google.maps.InfoWindow({
      //   content: 'out'
      // });
      setTimeout(function(){
            infowindow.close(map, marker);
      }, 800)
    })
  })
}






// socket.on('search-coords', function(search) {
//   // console.log('in index view, search is:', search);
//   // console.log('search.latitude:', search[0].latitude);
//   var focusCoords = [search[0].latitude, search[0].longitude];
//   console.log('in index.html, focusCoords:', focusCoords);
//   var map;
//
// });



</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBg7qsdMIt6_u3lp0AfjJoz41S2C8fyCRg&callback=initMap"
 async defer>

 </script>
